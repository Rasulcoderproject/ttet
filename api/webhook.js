export const config = {
  api: { bodyParser: false },
};

import fetch from "node-fetch";

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(200).send("OK");

  const buf = await new Promise((resolve) => {
    let data = "";
    req.on("data", (chunk) => (data += chunk));
    req.on("end", () => resolve(data));
  });

  let update;
  try {
    update = JSON.parse(buf.toString());
  } catch {
    return res.status(400).send("Bad JSON");
  }

  console.log("üì© Update:", update);

  if (update.message) {
    const chatId = update.message.chat.id;
    const text = update.message.text || "";

    // ===== –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É =====
    if (text.startsWith("/owner ")) {
      const messageToOwner = text.slice(7).trim();
      if (!messageToOwner) {
        await sendMessage(chatId, "‚ö† –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /owner");
      } else {
        await sendMessage(
          process.env.MY_TELEGRAM_ID,
          `üì© –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}:\n${messageToOwner}`
        );
        await sendMessage(chatId, "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü—É");
      }
      return res.status(200).send("ok");
    }

    // ===== –û—Ç–≤–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é =====
    if (String(chatId) === process.env.MY_TELEGRAM_ID && text.startsWith("/reply ")) {
      const parts = text.split(" ");
      const targetId = parts[1];
      const replyText = parts.slice(2).join(" ");

      if (!targetId || !replyText) {
        await sendMessage(process.env.MY_TELEGRAM_ID, "‚ö† –§–æ—Ä–º–∞—Ç: /reply <chat_id> <—Ç–µ–∫—Å—Ç>");
      } else {
        await sendMessage(targetId, replyText);
        await sendMessage(process.env.MY_TELEGRAM_ID, `‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetId}`);
      }
      return res.status(200).send("ok");
    }

    // ===== –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è =====
    await sendMessage(
      process.env.MY_TELEGRAM_ID,
      `üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç chat_id: ${chatId}\n–¢–µ–∫—Å—Ç: ${text}`
    );
  }

  return res.status(200).send("ok");
}

async function sendMessage(chatId, text) {
  return fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chat_id: chatId, text }),
  });
}
